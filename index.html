<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Retro Cassette Player</title>

<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://www.youtube.com/iframe_api"></script>

<style>
:root{
  --ink:#1b1b1b;
  --accent:#6a4a3a;
}
*{box-sizing:border-box}
body{
  margin:0;height:100vh;
  display:flex;justify-content:center;align-items:center;
  background:#e5e5e5;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--ink);
}
.player{
  width:360px;
  background:linear-gradient(180deg,#fafafa,#e0e0e0);
  border-radius:34px;
  padding:20px;
  box-shadow:0 40px 120px rgba(0,0,0,.25);
}

/* ===== CASSETTE ===== */
.cassette{
  background:#ddd;
  border-radius:18px;
  padding:18px;
  margin-bottom:16px;
  cursor:pointer;
}

/* ===== PANEL ===== */
.panel{
  max-height:0;
  opacity:0;
  transform:translateY(-10px);
  transition:.6s;
}
.player.open .panel{
  max-height:900px;
  opacity:1;
  transform:none;
}

/* ===== PLAYLIST ===== */
.folder{
  background:#f2f2f2;
  border-radius:18px;
  padding:10px;
  margin-bottom:12px;
}
.folder-header{
  display:flex;
  justify-content:space-between;
  font-size:13px;
}
.songs{margin-top:6px}

.song{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:13px;
  padding:6px 8px;
  border-radius:10px;
  cursor:grab;
}
.song.dragging{opacity:.4}
.song:hover{background:rgba(0,0,0,.05)}

.song-title{
  flex:1;
}
.song .x{
  opacity:.4;
  cursor:pointer;
}
</style>
</head>

<body>

<div class="player" id="player">

  <div class="cassette" onclick="togglePanel()">CASSETTE</div>

  <div class="panel">
    <div id="playlists"></div>
    <div onclick="addPlaylist()">＋ Add Playlist</div>
  </div>

</div>

<script>
/* ===== STATE ===== */
let data = JSON.parse(localStorage.getItem("cassettePlaylists")) || [
  { name:"My Playlist", songs:[
    {title:"Song 1"},
    {title:"Song 2"},
    {title:"Song 3"}
  ]}
]

let dragData = null
const playlistsEl = document.getElementById("playlists")

function save(){
  localStorage.setItem("cassettePlaylists", JSON.stringify(data))
}
function togglePanel(){
  document.getElementById("player").classList.toggle("open")
}

/* ===== RENDER + DRAG (PURE FROM OLD CODE, FIXED) ===== */
function render(){
  playlistsEl.innerHTML=""

  data.forEach((pl,pi)=>{
    const box=document.createElement("div")
    box.className="folder"

    /* DROP TO PLAYLIST */
    box.ondragover = e => e.preventDefault()
    box.ondrop = e => {
      e.preventDefault()
      if(!dragData || dragData.p === pi) return

      const song = data[dragData.p].songs.splice(dragData.s,1)[0]
      data[pi].songs.push(song)

      save()
      render()
    }

    box.innerHTML=`
      <div class="folder-header">
        <span>${pl.name}</span>
        <span onclick="deletePlaylist(${pi})">✕</span>
      </div>
      <div class="songs"></div>
    `

    const list = box.querySelector(".songs")

    pl.songs.forEach((s,si)=>{
      const row=document.createElement("div")
      row.className="song"
      row.draggable=true

      /* DRAG START / END */
      row.ondragstart = () => {
        dragData = { p:pi, s:si }
        row.classList.add("dragging")
      }
      row.ondragend = () => {
        row.classList.remove("dragging")
        dragData = null
      }

      /* REORDER */
      row.ondragover = e => e.preventDefault()
      row.ondrop = e => {
        e.preventDefault()
        if(!dragData) return

        const song = data[dragData.p].songs.splice(dragData.s,1)[0]
        data[pi].songs.splice(si,0,song)

        save()
        render()
      }

      /* IMPORTANT: CLICK DIPISAH */
      const title=document.createElement("span")
      title.className="song-title"
      title.textContent=s.title
      title.onclick=()=>alert("PLAY "+s.title)

      const del=document.createElement("span")
      del.className="x"
      del.textContent="✕"
      del.onclick=()=>deleteSong(pi,si)

      row.appendChild(title)
      row.appendChild(del)
      list.appendChild(row)
    })

    playlistsEl.appendChild(box)
  })
}
render()

/* ===== CRUD ===== */
function addPlaylist(){
  data.push({name:"New Playlist",songs:[]})
  save();render()
}
function deletePlaylist(i){
  data.splice(i,1)
  save();render()
}
function deleteSong(p,s){
  data[p].songs.splice(s,1)
  save();render()
}
</script>

</body>
</html>
